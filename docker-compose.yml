version: "3.8"

services:
  cronicle:
    build: .
    image: xentropics/cronicle:latest
    container_name: cronicle
    restart: unless-stopped

    # Run as non-root user (defined in Dockerfile)
    user: "1000:1000"

    # Security options
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default

    # Read-only root filesystem (except for mounted volumes)
    read_only: true

    # Drop all capabilities
    cap_drop:
      - ALL

    # Resource limits for DoS prevention
    mem_limit: 2g
    memswap_limit: 2g
    cpu_shares: 1024
    pids_limit: 200

    # Prevent container from gaining additional privileges
    privileged: false

    ports:
      - "3012:3012" # Cronicle Web UI

    environment:
      # Basic Configuration
      - CRONICLE_base_app_url=http://localhost:3012
      - CRONICLE_server_hostname=cronicle-server

      # Web Server
      - CRONICLE_web_http_port=3012
      # - CRONICLE_web_https_port=443

      # Email/SMTP Configuration (optional)
      # - CRONICLE_smtp_hostname=smtp.gmail.com
      # - CRONICLE_smtp_port=587
      # - CRONICLE_smtp_use_ssl=true
      # - CRONICLE_smtp_username=your-email@gmail.com
      # - CRONICLE_smtp_password=your-app-password
      # - CRONICLE_mail_from=cronicle@yourdomain.com

      # Storage Configuration
      - CRONICLE_storage_engine=Filesystem
      # - CRONICLE_storage_filesystem_dir=/opt/cronicle/data

      # For Couchbase (alternative storage)
      # - CRONICLE_storage_engine=Couchbase
      # - CRONICLE_storage_couchbase_host=localhost
      # - CRONICLE_storage_couchbase_bucket=cronicle
      # - CRONICLE_storage_couchbase_username=admin
      # - CRONICLE_storage_couchbase_password=password

      # For S3 (alternative storage)
      # - CRONICLE_storage_engine=S3
      # - CRONICLE_storage_s3_bucket=my-cronicle-bucket
      # - CRONICLE_storage_s3_region=us-east-1
      # - CRONICLE_storage_s3_keyprefix=cronicle/

      # Security
      - CRONICLE_secret_key=CHANGE_THIS_TO_A_RANDOM_STRING

      # Logging
      - CRONICLE_log_dir=/opt/cronicle/logs
      - CRONICLE_log_filename=cronicle.log
      - CRONICLE_log_level=9
      - CRONICLE_debug=false

      # Timezone
      - CRONICLE_timezone=America/New_York

      # Job Configuration
      - CRONICLE_max_jobs=10

      # Maintenance mode
      - CRONICLE_maintenance=false

      # Admin credentials (optional - auto-generated if not set)
      # - CRONICLE_ADMIN_USER=admin
      # - CRONICLE_ADMIN_PASSWORD=your-secure-password

    volumes:
      # Persistent data
      - cronicle-data:/opt/cronicle/data
      - cronicle-logs:/opt/cronicle/logs
      - cronicle-conf:/opt/cronicle/conf
      - cronicle-queue:/opt/cronicle/queue

      # Writable temp directories with size limits
      - type: tmpfs
        target: /tmp
        tmpfs:
          mode: 1777
          size: 100M
      - type: tmpfs
        target: /opt/cronicle/tmp
        tmpfs:
          mode: 0750
          size: 100M
      - type: tmpfs
        target: /var/tmp
        tmpfs:
          mode: 1777
          size: 50M

      # Mount workloads directory (jobs/scripts that Cronicle can execute)
      - ./workloads:/opt/cronicle/workloads:ro

      # Optional: Custom plugins (read-only for security)
      # - ./plugins:/opt/cronicle/plugins:ro

    networks:
      - cronicle-network

    # Disable default Docker DNS for additional isolation
    dns:
      - 1.1.1.1
      - 8.8.8.8

    # Hostname isolation
    hostname: cronicle
    domainname: local

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3012/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  cronicle-data:
    driver: local
  cronicle-logs:
    driver: local
  cronicle-conf:
    driver: local
  cronicle-queue:
    driver: local

networks:
  cronicle-network:
    driver: bridge
